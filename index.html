<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         GOOGLE ANALYTICS (invisible para el usuario)
         C√≥digo de seguimiento: G-FK92RC6VPR
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FK92RC6VPR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FK92RC6VPR');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Mi Gestor de Medicamentos y Actividades F√≠sicas de Salud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --azul: #1e40af;
            --morado: #7e22ce;
            --fondo: #f8fafc;
            --rojo-fuerte: #dc2626;
            --rojo-suave: #fee2e2;
            --verde-ok: #16a34a;
            --amarillo: #fef9c3;
            --gris: #64748b;
            --naranja: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        /* touch-action: manipulation previene el zoom de doble-tap en Android/iOS que causa pantalla negra */
        button, .nav-item, .circulo-vacio, .circulo-lleno, .btn-mini, .btn-save {
            touch-action: manipulation;
        }
        body { background: var(--fondo); padding-top: 165px; padding-bottom: 60px; user-select: none; }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header-app {
            position: fixed; top: 0; width: 100%; max-width: 850px;
            left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, var(--azul), var(--morado));
            color: white; text-align: center; padding: 14px 15px 14px 15px;
            z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .header-inner { display: flex; align-items: center; justify-content: center; position: relative; }
        .header-titulo { flex-grow: 1; text-align: center; padding-right: 100px; }
        .header-titulo h1 { font-size: 18px; font-weight: 800; line-height: 1.3; }
        .header-titulo p { font-size: 12px; font-style: italic; opacity: 0.92; margin-top: 2px; }
        .header-excel-btn {
            position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            background: white; color: #1e293b; font-size: 10px; font-weight: bold;
            padding: 7px 9px; border-radius: 8px; border: none; cursor: pointer;
            text-align: center; line-height: 1.4; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            white-space: nowrap; display: none;
        }
        .header-excel-btn:hover { background: #f0f0f0; }

        /* ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ */
        .navbar {
            position: fixed; top: 91px; width: 100%; max-width: 850px;
            left: 50%; transform: translateX(-50%);
            background: white; display: flex; border-bottom: 3px solid #cbd5e1; z-index: 1999;
        }
        .nav-item {
            flex: 1; padding: 10px 5px; text-align: center; cursor: pointer;
            font-weight: bold; font-size: 10.5px; color: #64748b; border-bottom: 4px solid transparent;
        }
        .nav-item.active { color: var(--azul); border-bottom: 4px solid var(--azul); background: #f8fafc; }

        /* ‚îÄ‚îÄ CONTENEDOR ‚îÄ‚îÄ */
        .container { max-width: 850px; margin: 0 auto; background: white; min-height: 80vh; padding: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

        /* ‚îÄ‚îÄ FORMULARIO ‚îÄ‚îÄ */
        .f-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #334155; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: #f9fafb; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--azul); background: white; }
        /* Estilos espec√≠ficos para inputs de hora/fecha en m√≥viles */
        input[type="time"], input[type="date"] {
            min-height: 50px;
            font-size: 16px !important; /* evita zoom autom√°tico en iOS */
            -webkit-tap-highlight-color: rgba(30,64,175,0.15);
            touch-action: manipulation; /* evita doble-tap zoom que puede cerrar la app */
        }
        input[type="time"] {
            background: #f0f4ff;
            border: 2px solid var(--azul);
            color: #1e293b;
            font-weight: bold;
        }
        .btn-save { width: 100%; padding: 16px; background: var(--azul); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-save:hover { background: #1e3a8a; }

        /* ‚îÄ‚îÄ CARDS REGISTROS ‚îÄ‚îÄ */
        .card-reg { border: 4px solid #cbd5e1; border-radius: 12px; padding: 15px; margin-bottom: 20px; position: relative; background: #fff; }
        .card-header-btns { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .btn-mini { padding: 6px 12px; font-size: 12px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; }
        .btn-edit { background: var(--naranja); color: #000; }
        .btn-del { background: var(--rojo-fuerte); color: #fff; }
        .card-paciente { font-weight: bold; color: var(--azul); font-size: 14px; margin-bottom: 4px; }
        .card-med { font-size: 20px; font-weight: 800; color: #1e293b; margin-bottom: 4px; }
        .card-tipo { color: var(--azul); font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .card-termino { color: var(--rojo-fuerte); font-weight: 900; }
        .card-line { margin-bottom: 6px; font-size: 14px; color: #334155; display: flex; align-items: baseline; flex-wrap: wrap; }
        .lbl-negrita { font-weight: bold; margin-right: 5px; color: #000; }
        .val-azul-negrita { font-weight: 800; color: var(--azul); }
        .val-normal { font-weight: normal; color: #475569; }
        .val-alarma-style { font-weight: normal; color: #000; }
        .card-footer { background: #f8fafc; padding: 10px; border-radius: 6px; font-size: 13px; margin-top: 10px; border: 1px solid #e2e8f0; }

        /* ‚îÄ‚îÄ SECCI√ìN 3 ‚îÄ‚îÄ */
        @keyframes parpadeoBorde {
            0%   { border-color: var(--rojo-fuerte); box-shadow: 0 0 5px var(--rojo-fuerte); }
            50%  { border-color: #ef4444; box-shadow: 0 0 15px #ef4444; }
            100% { border-color: var(--rojo-fuerte); box-shadow: 0 0 5px var(--rojo-fuerte); }
        }
        @keyframes parpadeoTexto {
            0%,100% { opacity: 1; }
            50%      { opacity: 0.2; }
        }

        .msg-bloqueo {
            color: var(--rojo-fuerte); font-weight: 900; text-align: center;
            margin-bottom: 15px; font-size: 14px; border: 2px solid var(--rojo-fuerte);
            padding: 12px; background: #fff0f0; border-radius: 8px;
            animation: parpadeoTexto 1.2s infinite;
        }
        .toma-item { display: flex; align-items: center; padding: 15px; border: 2px solid #cbd5e1; border-radius: 12px; margin-bottom: 12px; }
        .toma-pendiente { background-color: var(--rojo-suave); border-color: #fca5a5; }
        .toma-futura  { background-color: var(--amarillo); border-color: #fde047; }
        .toma-marcada { background-color: #f1f5f9; opacity: 0.6; }
        .toma-marcada .texto-tachado { text-decoration: line-through; text-decoration-style: double; color: var(--gris); }
        .toma-bloqueada { opacity: 0.4; pointer-events: none; background: #e2e8f0; filter: grayscale(100%); }
        .toma-espera    { background: #f8fafc; border-color: #cbd5e1; opacity: 0.8; }

        /* √≠tem pendiente con parpadeo */
        .toma-item-pendiente-rojo {
            background-color: var(--rojo-suave) !important;
            border-color: var(--rojo-fuerte) !important;
            animation: parpadeoBorde 1.5s infinite;
        }
        .texto-pendiente-rojo {
            color: var(--rojo-fuerte) !important;
            font-weight: 900 !important;
            animation: parpadeoTexto 1.2s infinite;
        }

        .contenedor-check { width: 42px; height: 42px; margin-right: 15px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .circulo-vacio    { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--azul); background: white; cursor: pointer; }
        .circulo-lleno    { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--verde-ok); background: var(--verde-ok); color: white; font-size: 24px; font-weight: 900; display: flex; align-items: center; justify-content: center; }
        .circulo-disabled { border: 3px solid #94a3b8 !important; background: #e2e8f0 !important; cursor: not-allowed; }

        .pendientes-grupo { border: 3px dashed var(--rojo-fuerte); padding: 15px; border-radius: 10px; margin-bottom: 15px; background: #fff1f2; display: flex; justify-content: space-between; align-items: center; animation: parpadeoBorde 1.5s infinite; }
        .titulo-pendiente { font-weight: 800; font-size: 15px; color: var(--rojo-fuerte); text-transform: uppercase; }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 380px; text-align: center; }
        .modal-header { font-weight: bold; color: #1e293b; margin-bottom: 15px; font-size: 15px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="header-app">
        <div class="header-inner">
            <div class="header-titulo">
                <h1>Mi gestor de medicamentos y actividades f√≠sicas de salud</h1>
                <p>(APP para ser usada principalmente por adultos mayores y cuidadores)</p>
            </div>
            <button class="header-excel-btn" id="btn-header-excel" onclick="validarExcel()">
                descarga aqu√≠<br>archivo excel<br>hist√≥rico
            </button>
        </div>
    </header>

    <nav class="navbar">
        <div class="nav-item active" onclick="nav(0, 'sec-add')">‚ûï<br>AGREGAR</div>
        <div class="nav-item" onclick="nav(1, 'sec-list')">üìã<br>REGISTROS</div>
        <div class="nav-item" onclick="nav(2, 'sec-today')">‚è∞<br>MIS REGISTROS HOY<br>(Y PENDIENTES)</div>
    </nav>

    <div class="container">

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SECCI√ìN 1: AGREGAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="sec-add">
            <input type="hidden" id="edit-id">
            <div class="f-group">
                <label>üë§ Nombre del Paciente</label>
                <input type="text" id="paciente" placeholder="Nombre completo">
            </div>
            <div class="f-group">
                <label>üíä Medicamento / Actividad</label>
                <input type="text" id="medicina" placeholder="Ej: Losartan / Kinesiolog√≠a">
            </div>
            <div class="f-group">
                <label>‚öñÔ∏è Dosis / Detalle</label>
                <input type="text" id="dosis" placeholder="Ej: 1 pastilla / Fortalecer rodilla">
            </div>
            <div class="f-group">
                <label>üõ†Ô∏è Tipo de tratamiento</label>
                <select id="tipo" onchange="toggleTemporal(this.value)">
                    <option value="permanente">Permanente</option>
                    <option value="temporal">Temporal</option>
                </select>
            </div>
            <div id="box-dias" class="f-group hidden">
                <label>üìÖ Duraci√≥n en d√≠as</label>
                <input type="number" id="duracion" value="1" min="1">
            </div>
            <div class="f-group">
                <label>üìÖ Fecha Inicio</label>
                <input type="date" id="f-inicio" autocomplete="off">
            </div>
            <div class="f-group">
                <label>üïí Hora Inicio</label>
                <div style="position:relative;">
                    <input type="time" id="h-inicio" autocomplete="off"
                           style="cursor:pointer; font-size:18px; padding:14px 12px; background:#f0f4ff; border:2px solid var(--azul); width:100%; border-radius:8px;">
                </div>
                <div style="font-size:12px; color:var(--gris); margin-top:4px;">
                    üì± Toque el campo para seleccionar la hora
                </div>
            </div>
            <div class="f-group">
                <label>üîÑ Frecuencia</label>
                <select id="frecuencia" onchange="toggleFrecDias(this.value)">
                    <option value="4">Cada 4 horas</option>
                    <option value="6">Cada 6 horas</option>
                    <option value="8">Cada 8 horas</option>
                    <option value="12">Cada 12 horas</option>
                    <option value="24" selected>Diariamente</option>
                    <option value="X-DIAS">Cada (cantidad de) d√≠as</option>
                </select>
            </div>
            <div id="box-frec-dias" class="f-group hidden">
                <label>üî¢ Cantidad de d√≠as entre cada dosis</label>
                <input type="number" id="val-frec-dias" value="2" min="2">
            </div>
            <div class="f-group">
                <label>üîî Alarma</label>
                <select id="alarma" onchange="validarAlarma(this)">
                    <option value="Sin alarma">Sin alarma</option>
                    <option value="Moderada">Alarma moderada</option>
                    <option value="Fuerte">Alarma fuerte</option>
                </select>
            </div>
            <div class="f-group">
                <label>üìù Notas Adicionales</label>
                <textarea id="notas" rows="2" placeholder="Ej: Tomar con comida, no exponer al sol..."></textarea>
            </div>
            <button class="btn-save" id="btn-save" onclick="guardarDatos()">üíæ GUARDAR REGISTRO</button>
            <button class="btn-save hidden" id="btn-cancelar" style="margin-top:8px; background:var(--gris);" onclick="cancelarEdicion()">‚úñ CANCELAR EDICI√ìN</button>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SECCI√ìN 2: REGISTROS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="sec-list" class="hidden">
            <div id="cont-registros"></div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SECCI√ìN 3: HOY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="sec-today" class="hidden">
            <div id="header-fecha" style="font-weight:800; font-size:16px; color:var(--azul); margin-bottom:10px;"></div>
            <div id="aviso-bloqueo" class="msg-bloqueo hidden">‚ö†Ô∏è HAY MEDICAMENTOS Y ACTIVIDADES PENDIENTES POR MARCAR</div>
            <div id="cont-pendientes"></div>
            <hr id="hr-sep" style="margin:15px 0; border-top:2px solid #ddd;" class="hidden">
            <div id="cont-hoy"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL CLAVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="modal-sec" class="modal">
        <div class="modal-box">
            <div id="modal-txt" class="modal-header"></div>
            <input type="password" id="input-clave" placeholder="Ingrese la clave" style="margin-bottom:10px;">
            <p style="font-size:11px; color:var(--gris); margin-bottom:15px;">
                La clave debe ser solicitada al administrador de esta aplicaci√≥n
            </p>
            <button class="btn-save" style="padding:12px; background:var(--verde-ok);" onclick="checkClave()">‚úÖ Validar</button>
            <button class="btn-save" style="margin-top:8px; padding:12px; background:var(--gris);" onclick="cerrarModal()">Cancelar</button>
        </div>
    </div>

    <script>
        // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        // ‚ïë  CLAVES DE ACCESO ‚Äî identificadas con comentario especial           ‚ïë
        // ‚ïë  (estas 2 l√≠neas contienen las claves del sistema)                  ‚ïë
        // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        const PASS_EXCEL  = "HISTORICOjpm2026";   /* ‚óÑ‚îÄ CLAVE EXCEL  */
        const PASS_SONIDO = "SONIDOjpm2026";       /* ‚óÑ‚îÄ CLAVE ALARMA */

        // Claves de almacenamiento local (√∫nicas por navegador/dispositivo)
        const KEY_MEDS  = "DB_MEDS_GESTOR_SALUD_V1";
        const KEY_TOMAS = "DB_TOMAS_GESTOR_SALUD_V1";

        let medicinas = JSON.parse(localStorage.getItem(KEY_MEDS)  || '[]');
        let tomas     = JSON.parse(localStorage.getItem(KEY_TOMAS) || '{}');
        let audioCtx  = null, wakeLock = null, modoClave = "";
        let audioIniciado = false;
        let vigiliaPendiente = false; // bandera: hay intento de vigilia pendiente

        // Inicializar fecha de hoy en el formulario
        document.getElementById('f-inicio').valueAsDate = new Date();

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROTOCOLO VIGILIA SEGURO PARA M√ìVILES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // REGLA T√âCNICA CR√çTICA EN iOS/Android:
        // El AudioContext y WakeLock SOLO pueden iniciarse desde un evento de usuario
        // DIRECTO (touchend/click) ‚Äî no desde timers, promesas encadenadas ni eventos
        // que hayan pasado por el picker nativo de fecha/hora.
        // Por eso se elimina body.onclick y se usa un bot√≥n dedicado que no interfiere
        // con los inputs del formulario.

        async function activarProtocoloVigilia() {
            if (audioIniciado) return;
            // No intentar si hay un input de formulario con foco (el picker podr√≠a estar abierto)
            const el = document.activeElement;
            if (el && (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA')) {
                vigiliaPendiente = true;
                return;
            }
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }
                // Nodo silencioso que mantiene el contexto activo
                const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.loop = true;
                const gainNode = audioCtx.createGain();
                gainNode.gain.value = 0.001; // casi silencio, no molesta
                source.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                source.start();
                // WakeLock en bloque separado para no abortar si el browser no lo soporta
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch(wErr) { /* wakeLock no cr√≠tico */ }
                audioIniciado = true;
                vigiliaPendiente = false;
            } catch(err) {
                // Error silencioso ‚Äî no interrumpir el flujo del usuario
            }
        }

        // Activar vigilia cuando el usuario suelte cualquier toque fuera de los inputs
        document.addEventListener('touchend', function(e) {
            const t = e.target;
            if (t && (t.tagName === 'INPUT' || t.tagName === 'SELECT' || t.tagName === 'TEXTAREA')) return;
            if (!audioIniciado) activarProtocoloVigilia();
        }, {passive: true});

        document.addEventListener('click', function(e) {
            const t = e.target;
            if (t && (t.tagName === 'INPUT' || t.tagName === 'SELECT' || t.tagName === 'TEXTAREA')) return;
            if (!audioIniciado) activarProtocoloVigilia();
        });

        // Si el usuario cierra el picker (blur del input), intentar activar vigilia si estaba pendiente
        document.addEventListener('focusout', function(e) {
            if (vigiliaPendiente) {
                setTimeout(activarProtocoloVigilia, 300);
            }
        });

        // Reactivar WakeLock si el sistema lo libera (ej: pantalla apagada brevemente)
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && audioIniciado) {
                try {
                    if ('wakeLock' in navigator && (!wakeLock || wakeLock.released)) {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch(e) {}
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SISTEMA DE ALARMA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        setInterval(() => {
            if (calcularEstadoGlobal()) sonarSirena();
        }, 8000);

        function calcularEstadoGlobal() {
            const hoy = new Date();
            return medicinas.some(m => {
                if (m.alarma === 'Sin alarma') return false;
                let cursor = new Date(m.fIni + "T" + m.hIni);
                while (cursor <= hoy) {
                    const key = `${m.id}_${cursor.getTime()}`;
                    if (!tomas[key]) return true;
                    cursor = sumarFrecuencia(cursor, m);
                    if (m.tipo === 'temporal') {
                        const fin = calcularFin(m);
                        const finDate = new Date(fin.isoDate + "T" + fin.h2);
                        if (cursor > finDate) break;
                    }
                }
                return false;
            });
        }

        function sonarSirena() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = "square";
            const now = audioCtx.currentTime;
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.linearRampToValueAtTime(1200, now + 1);
            osc.frequency.linearRampToValueAtTime(880, now + 2);
            osc.frequency.linearRampToValueAtTime(1200, now + 3);
            osc.frequency.linearRampToValueAtTime(880, now + 4);
            osc.frequency.linearRampToValueAtTime(1200, now + 5);
            osc.frequency.linearRampToValueAtTime(880, now + 6);
            gain.gain.value = 0.5;
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 6);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVEGACI√ìN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function nav(idx, id) {
            document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item')[idx].classList.add('active');
            // Mostrar/ocultar bot√≥n excel en header
            document.getElementById('btn-header-excel').style.display = (id === 'sec-list') ? 'block' : 'none';
            if (id === 'sec-list')  renderRegistros();
            if (id === 'sec-today') renderHoy();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORMULARIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function toggleTemporal(v)  { document.getElementById('box-dias').classList.toggle('hidden', v !== 'temporal'); }
        function toggleFrecDias(v)  { document.getElementById('box-frec-dias').classList.toggle('hidden', v !== 'X-DIAS'); }

        function validarAlarma(el) {
            if (el.value === "Sin alarma") return;
            modoClave = "ALARMA";
            abrirModal("Se requiere clave para activar la alarma.\nSolic√≠tela al administrador de esta aplicaci√≥n.");
        }

        function guardarDatos() {
            // Intentar activar vigilia con peque√±o delay para no interferir
            setTimeout(activarProtocoloVigilia, 100);
            const idEdit = document.getElementById('edit-id').value;
            const nuevo = {
                id:       idEdit ? parseInt(idEdit) : Date.now(),
                paciente: document.getElementById('paciente').value.trim(),
                medicina: document.getElementById('medicina').value.trim(),
                dosis:    document.getElementById('dosis').value.trim(),
                tipo:     document.getElementById('tipo').value,
                duracion: document.getElementById('duracion').value,
                fIni:     document.getElementById('f-inicio').value,
                hIni:     document.getElementById('h-inicio').value,
                frec:     document.getElementById('frecuencia').value,
                frecVal:  document.getElementById('val-frec-dias').value,
                alarma:   document.getElementById('alarma').value,
                notas:    document.getElementById('notas').value.trim()
            };
            if (!nuevo.paciente || !nuevo.medicina || !nuevo.fIni || !nuevo.hIni) {
                return alert("Faltan datos obligatorios (paciente, medicamento/actividad, fecha y hora de inicio)");
            }
            if (idEdit) {
                medicinas[medicinas.findIndex(m => m.id == idEdit)] = nuevo;
            } else {
                medicinas.push(nuevo);
            }
            localStorage.setItem(KEY_MEDS, JSON.stringify(medicinas));
            resetForm();
            nav(1, 'sec-list');
        }

        function resetForm() {
            document.getElementById('edit-id').value     = "";
            document.getElementById('paciente').value    = "";
            document.getElementById('medicina').value    = "";
            document.getElementById('dosis').value       = "";
            document.getElementById('tipo').value        = "permanente";
            document.getElementById('duracion').value    = "1";
            document.getElementById('f-inicio').valueAsDate = new Date();
            document.getElementById('h-inicio').value    = "";
            document.getElementById('frecuencia').value  = "24";
            document.getElementById('val-frec-dias').value = "2";
            document.getElementById('alarma').value      = "Sin alarma";
            document.getElementById('notas').value       = "";
            document.getElementById('btn-save').innerText = "üíæ GUARDAR REGISTRO";
            document.getElementById('btn-cancelar').classList.add('hidden');
            toggleTemporal('permanente');
            toggleFrecDias('24');
        }

        function cancelarEdicion() {
            resetForm();
            nav(1, 'sec-list');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SECCI√ìN 2: RENDERIZAR REGISTROS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderRegistros() {
            const cont = document.getElementById('cont-registros');
            cont.innerHTML = "";
            if (medicinas.length === 0) {
                cont.innerHTML = `<div style="text-align:center; padding:40px; color:var(--gris);">
                    <p style="font-size:18px;">üìã No hay registros a√∫n</p>
                    <p style="font-size:14px; margin-top:10px;">Ve a la secci√≥n <strong>AGREGAR</strong> para crear el primer registro.</p>
                </div>`;
                return;
            }
            medicinas.forEach(m => {
                const duracionVal = m.tipo === 'permanente' ? "Indefinida" : `${m.duracion} d√≠as`;
                let terminoTxt = "";
                if (m.tipo === 'temporal') {
                    const fin = calcularFin(m);
                    terminoTxt = ` <span class="card-termino">(t√©rmino de tratamiento ${fin.f} ${fin.h})</span>`;
                }
                const frecTxt = m.frec === 'X-DIAS'
                    ? `Cada ${m.frecVal} d√≠as`
                    : (m.frec == 24 ? "Diariamente" : `Cada ${m.frec} horas`);

                cont.innerHTML += `
                <div class="card-reg">
                    <div class="card-header-btns">
                        <button class="btn-mini btn-edit" onclick="editar(${m.id})">Editar</button>
                        <button class="btn-mini btn-del"  onclick="eliminar(${m.id})">Eliminar</button>
                    </div>
                    <div class="card-paciente">üë§ ${m.paciente}</div>
                    <div class="card-med">${m.medicina}</div>
                    <div class="card-tipo">Tratamiento ${m.tipo}${terminoTxt}</div>
                    <div class="card-line"><span class="lbl-negrita">Duraci√≥n:</span>
                        <span class="val-normal">${duracionVal}</span></div>
                    <div class="card-line"><span class="lbl-negrita">Dosis:</span>
                        <span class="val-azul-negrita">${m.dosis}</span></div>
                    <div class="card-line"><span class="lbl-negrita">Frecuencia:</span>
                        <span class="val-azul-negrita">${frecTxt}</span></div>
                    <div class="card-line"><span class="lbl-negrita">Inicio de tratamiento:</span>
                        <span class="val-normal">${formatoFecha(m.fIni)} ${m.hIni}</span></div>
                    <div class="card-line"><span class="lbl-negrita">Alarma:</span>
                        <span class="val-alarma-style">${m.alarma}</span></div>
                    <div class="card-footer"><span class="lbl-negrita">Notas:</span>
                        <span class="val-azul-negrita">${m.notas || '‚Äî'}</span></div>
                </div>`;
            });
        }

        // EDITAR: carga TODOS los campos (paciente, medicina, dosis, tipo, duracion, fechas, frecuencia, alarma, notas)
        function editar(id) {
            const m = medicinas.find(x => x.id == id);
            if (!m) return;
            document.getElementById('edit-id').value      = m.id;
            document.getElementById('paciente').value     = m.paciente;
            document.getElementById('medicina').value     = m.medicina;
            document.getElementById('dosis').value        = m.dosis;
            document.getElementById('tipo').value         = m.tipo;
            document.getElementById('duracion').value     = m.duracion || "1";
            document.getElementById('f-inicio').value     = m.fIni;
            document.getElementById('h-inicio').value     = m.hIni;
            document.getElementById('frecuencia').value   = m.frec;
            document.getElementById('val-frec-dias').value= m.frecVal || "2";
            document.getElementById('alarma').value       = m.alarma;
            document.getElementById('notas').value        = m.notas || "";
            toggleTemporal(m.tipo);
            toggleFrecDias(m.frec);
            document.getElementById('btn-save').innerText = "üíæ ACTUALIZAR REGISTRO";
            document.getElementById('btn-cancelar').classList.remove('hidden');
            nav(0, 'sec-add');
            window.scrollTo(0, 0);
        }

        function eliminar(id) {
            if (confirm("¬øEst√° seguro de eliminar este registro?\nEsta acci√≥n no se puede deshacer.")) {
                medicinas = medicinas.filter(m => m.id !== id);
                localStorage.setItem(KEY_MEDS, JSON.stringify(medicinas));
                renderRegistros();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SECCI√ìN 3: RENDERIZAR HOY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderHoy() {
            setTimeout(activarProtocoloVigilia, 100);
            const hoy = new Date();
            document.getElementById('header-fecha').innerText =
                `Hoy: ${hoy.toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'})}`;

            const contP = document.getElementById('cont-pendientes');
            const contH = document.getElementById('cont-hoy');
            contP.innerHTML = "";
            contH.innerHTML = "";

            let pendientesPorDia  = {};
            let pendientesMismosDia = []; // pendientes de hoy que ya pasaron
            let horariosHoy       = [];
            let hayPendientesPrevios = false;

            medicinas.forEach(m => {
                let cursor = new Date(m.fIni + "T" + m.hIni);
                const limitePasado = new Date(); limitePasado.setDate(limitePasado.getDate() - 10);
                const finHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 23, 59, 59);
                let finTratamiento = new Date(9999, 11, 31);

                if (m.tipo === 'temporal') {
                    finTratamiento = new Date(m.fIni + "T" + m.hIni);
                    finTratamiento.setDate(finTratamiento.getDate() + parseInt(m.duracion));
                }

                while (cursor <= finHoy && cursor <= finTratamiento) {
                    if (cursor < limitePasado) { cursor = sumarFrecuencia(cursor, m); continue; }
                    const key = `${m.id}_${cursor.getTime()}`;
                    const fechaStr = cursor.toLocaleDateString('es-ES');

                    if (cursor.toDateString() !== hoy.toDateString()) {
                        if (!tomas[key]) {
                            if (!pendientesPorDia[fechaStr]) pendientesPorDia[fechaStr] = [];
                            pendientesPorDia[fechaStr].push({ key, med: m.medicina, dosis: m.dosis, pac: m.paciente });
                            hayPendientesPrevios = true;
                        }
                    } else {
                        horariosHoy.push({
                            id: m.id, med: m.medicina, dosis: m.dosis, pac: m.paciente,
                            hora: new Date(cursor), key: key
                        });
                    }
                    cursor = sumarFrecuencia(cursor, m);
                }
            });

            // Mostrar aviso e √≠tems de d√≠as anteriores con parpadeo rojo
            document.getElementById('aviso-bloqueo').classList.toggle('hidden', !hayPendientesPrevios);
            document.getElementById('hr-sep').classList.toggle('hidden', !hayPendientesPrevios);

            Object.keys(pendientesPorDia).sort().forEach(dia => {
                const items = pendientesPorDia[dia];
                const keysJSON = JSON.stringify(items.map(i => i.key));
                let listItems = items.map(i =>
                    `<div class="texto-pendiente-rojo" style="font-size:13px; margin-top:3px;">‚Ä¢ ${i.med} - ${i.dosis} (${i.pac})</div>`
                ).join('');
                contP.innerHTML += `
                <div class="toma-item toma-item-pendiente-rojo" style="flex-direction:column; align-items:flex-start;">
                    <div style="display:flex; width:100%; justify-content:space-between; align-items:center;">
                        <div class="texto-pendiente-rojo" style="font-size:15px; text-transform:uppercase;">
                            ‚ö†Ô∏è PENDIENTES DEL ${dia}
                        </div>
                        <div class="contenedor-check">
                            <div class="circulo-vacio" onclick='marcarGrupo(${keysJSON})'></div>
                        </div>
                    </div>
                    <div style="font-size:12px; color:var(--rojo-fuerte); margin-top:4px;">
                        Marque aqu√≠ para habilitar los medicamentos de hoy
                    </div>
                    ${listItems}
                </div>`;
            });

            horariosHoy.sort((a, b) => a.hora - b.hora);
            let bloqueoCascada = hayPendientesPrevios;

            horariosHoy.forEach(t => {
                const completada  = tomas[t.key];
                const esPasada    = t.hora < hoy;
                const diffMs      = t.hora - hoy;
                const diffMins    = diffMs / 1000 / 60;
                const esFuturoLejano = diffMins > 5;

                let disabled = false;
                if (!completada) {
                    if (bloqueoCascada)    disabled = true;
                    else if (esFuturoLejano) disabled = true;
                }

                let claseExtra = "", htmlCheck = "";
                const esPendienteHoy = !completada && esPasada; // pendiente del mismo d√≠a

                if (completada) {
                    claseExtra = "toma-marcada";
                    htmlCheck  = `<div class="circulo-lleno" onclick="marcar('${t.key}')">‚úì</div>`;
                } else if (disabled) {
                    claseExtra = (esFuturoLejano && !bloqueoCascada) ? "toma-espera" : "toma-bloqueada";
                    htmlCheck  = `<div class="circulo-vacio circulo-disabled"></div>`;
                } else {
                    claseExtra = esPasada ? "toma-pendiente" : "toma-futura";
                    htmlCheck  = `<div class="circulo-vacio" onclick="marcar('${t.key}')"></div>`;
                }

                // Si es pendiente del mismo d√≠a y no est√° bloqueada, aplicar parpadeo
                const clasePendienteRojo = (esPendienteHoy && !disabled) ? "toma-item-pendiente-rojo" : "";

                contH.innerHTML += `
                <div class="toma-item ${claseExtra} ${clasePendienteRojo}">
                    <div class="contenedor-check">${htmlCheck}</div>
                    <div>
                        <div class="texto-tachado ${esPendienteHoy && !disabled ? 'texto-pendiente-rojo' : ''}"
                             style="font-weight:bold; font-size:13px;">
                            ${t.hora.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                        </div>
                        <div class="texto-tachado ${esPendienteHoy && !disabled ? 'texto-pendiente-rojo' : ''}"
                             style="font-size:17px; font-weight:800;">
                            ${t.med} - ${t.dosis}
                        </div>
                        <div style="font-size:13px; color:var(--gris)">${t.pac}</div>
                    </div>
                </div>`;

                if (!completada && esPasada) bloqueoCascada = true;
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FUNCIONES AUXILIARES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function sumarFrecuencia(fecha, m) {
            const nueva = new Date(fecha);
            if (m.frec === 'X-DIAS') nueva.setDate(nueva.getDate() + parseInt(m.frecVal));
            else nueva.setHours(nueva.getHours() + parseInt(m.frec));
            return nueva;
        }

        function marcar(key) {
            if (tomas[key]) delete tomas[key];
            else tomas[key] = true;
            localStorage.setItem(KEY_TOMAS, JSON.stringify(tomas));
            renderHoy();
        }

        function marcarGrupo(keys) {
            keys.forEach(k => tomas[k] = true);
            localStorage.setItem(KEY_TOMAS, JSON.stringify(tomas));
            renderHoy();
        }

        function formatoFecha(f) {
            if (!f) return "";
            const [y, m, d] = f.split('-');
            return `${d}-${m}-${y}`;
        }

        function calcularFin(m) {
            const d = new Date(m.fIni + "T" + m.hIni);
            d.setDate(d.getDate() + parseInt(m.duracion));
            const isoDate = d.toISOString().split('T')[0];
            const h  = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const h2 = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            return { f: formatoFecha(isoDate), h, h2, isoDate };
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL Y CLAVES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function validarExcel() {
            modoClave = "EXCEL";
            abrirModal("Debe solicitar la clave al administrador de esta aplicaci√≥n para descargar el historial Excel.");
        }

        function abrirModal(txt) {
            document.getElementById('modal-txt').innerText = txt;
            document.getElementById('input-clave').value   = "";
            document.getElementById('modal-sec').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modal-sec').style.display = 'none';
            if (modoClave === "ALARMA") document.getElementById('alarma').value = "Sin alarma";
        }

        function checkClave() {
            const p = document.getElementById('input-clave').value;
            if (modoClave === "ALARMA" && p === PASS_SONIDO) {          /* ‚óÑ‚îÄ VERIFICA CLAVE ALARMA */
                document.getElementById('modal-sec').style.display = 'none';
            } else if (modoClave === "EXCEL" && p === PASS_EXCEL) {     /* ‚óÑ‚îÄ VERIFICA CLAVE EXCEL  */
                document.getElementById('modal-sec').style.display = 'none';
                generarExcel();
            } else {
                alert("Clave incorrecta. Por favor solicite la clave al administrador.");
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GENERACI√ìN EXCEL HIST√ìRICO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Estructura: paciente | mes | dia | medicamento(hora) ... | clave excel | clave alarma
        function generarExcel() {
            if (medicinas.length === 0) {
                alert("No hay registros para exportar.");
                return;
            }

            // Construir lista de columnas √∫nicas: nombre(hora)
            const allItems = [];
            medicinas.forEach(med => {
                const tiempos = getTiemposMedicamento(med);
                tiempos.forEach(t => {
                    allItems.push({
                        id: med.id,
                        nombre: med.medicina,
                        dosis: med.dosis,
                        tiempo: t,
                        header: `${med.medicina}(${t})`
                    });
                });
            });
            allItems.sort((a, b) => a.header.localeCompare(b.header));
            const headersUnicos = [...new Set(allItems.map(i => i.header))];

            // Armar filas d√≠a por d√≠a (√∫ltimos 180 d√≠as)
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const inicio180 = new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000);

            const excelData = [];
            // Fila cabecera
            excelData.push(['paciente', 'mes', 'dia', ...headersUnicos, 'clave excel', 'clave alarma']);

            for (let d = new Date(inicio180); d <= today; d.setDate(d.getDate() + 1)) {
                const fechaActual = new Date(d);
                const horariosDelDia = [];

                medicinas.forEach(m => {
                    if (!debeTomarEnFecha(m, fechaActual)) return;
                    const tiempos = getTiemposMedicamento(m);
                    tiempos.forEach(t => {
                        // Construir Date completo para obtener key
                        const [hh, mm] = t.split(':').map(Number);
                        const diaConHora = new Date(fechaActual.getFullYear(), fechaActual.getMonth(), fechaActual.getDate(), hh, mm, 0);
                        const key = `${m.id}_${diaConHora.getTime()}`;
                        const tomado = tomas[key];
                        horariosDelDia.push({
                            header: `${m.medicina}(${t})`,
                            valor: tomado ? m.dosis : 'no',
                            paciente: m.paciente
                        });
                    });
                });

                if (horariosDelDia.length > 0) {
                    // Agrupar por paciente para esta fila
                    const pacientes = [...new Set(horariosDelDia.map(h => h.paciente))];
                    pacientes.forEach(pac => {
                        const datosPac = horariosDelDia.filter(h => h.paciente === pac);
                        const mapaVal = new Map();
                        datosPac.forEach(h => mapaVal.set(h.header, h.valor));

                        const fila = [
                            pac,
                            fechaActual.toLocaleString('es-ES', {month:'short'}),
                            fechaActual.getDate()
                        ];
                        headersUnicos.forEach(h => fila.push(mapaVal.get(h) || ''));
                        fila.push(PASS_EXCEL);   // ‚óÑ‚îÄ clave excel en columna
                        fila.push(PASS_SONIDO);  // ‚óÑ‚îÄ clave alarma en columna
                        excelData.push(fila);
                    });
                }
            }

            // Crear libro Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            // Anchos de columna
            const colWidths = [{wch:18}, {wch:6}, {wch:5}];
            headersUnicos.forEach(() => colWidths.push({wch:22}));
            colWidths.push({wch:20}, {wch:18});
            ws['!cols'] = colWidths;
            XLSX.utils.book_append_sheet(wb, ws, "Historial_Salud");
            XLSX.writeFile(wb, `Historial_Salud_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Obtener lista de horas (string HH:MM) para un medicamento en un d√≠a cualquiera
        function getTiemposMedicamento(med) {
            if (med.frec === 'X-DIAS') return [med.hIni];
            const tiempos = [];
            const [hIni, mIni] = med.hIni.split(':').map(Number);
            const intervalo = parseInt(med.frec);
            if (isNaN(intervalo) || intervalo <= 0) return [med.hIni];
            let hora = hIni;
            const veces = Math.floor(24 / intervalo);
            for (let i = 0; i < veces; i++) {
                tiempos.push(`${String(hora).padStart(2,'0')}:${String(mIni).padStart(2,'0')}`);
                hora = (hora + intervalo) % 24;
            }
            return [...new Set(tiempos)].sort();
        }

        // Determinar si un medicamento se debe tomar en una fecha dada
        function debeTomarEnFecha(med, fecha) {
            const inicio = new Date(med.fIni + "T00:00:00");
            if (fecha < inicio) return false;
            if (med.tipo === 'temporal' && med.duracion) {
                const fin = new Date(inicio.getTime() + parseInt(med.duracion) * 24 * 60 * 60 * 1000);
                fin.setHours(23, 59, 59);
                if (fecha > fin) return false;
            }
            if (med.frec === 'X-DIAS' && med.frecVal) {
                const diff = Math.round((fecha - inicio) / (1000 * 60 * 60 * 24));
                return diff % parseInt(med.frecVal) === 0;
            }
            return true;
        }
    </script>
</body>
</html>
